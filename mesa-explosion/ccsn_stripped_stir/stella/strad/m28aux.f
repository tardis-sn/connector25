      SUBROUTINEM30Y12(NN,ICN,A,LICN,LENR,LENRL,IDISP,IP,IQ,IRN,LIRN,LENC,IFIRST,LASTR,NEXTR,LASTC,NEXTC,IPTR,IPC,U,ABORT,IFAIL,THR)
      DOUBLEPRECISIONU
      DOUBLEPRECISIONTHR
      INTEGERIFAIL,LICN,LIRN,NN
      DOUBLEPRECISIONA(LICN)
      INTEGERICN(LICN),IDISP(11),IFIRST(NN),IP(NN),IPC(NN),IPTR(NN),IQ(NN),IRN(LIRN),LASTC(NN),LASTR(NN),LENC(NN),LENR(NN),LENRL(NN)
     *,NEXTC(NN),NEXTR(NN)
      LOGICALABORT(3)
      DOUBLEPRECISIONRMAX,AU,UMAX,ZERO
      INTEGER*8JCOST,KCOST,N8
      INTEGERDISPC,I1,I2,I,IACTIV,IBEG,ICNCP,IDISPC,IDUMMY,IEND,IFILL,IFIR,II,III,IJFIR,IJP1,IJPOS,ILAST,INDROW,IOP,IPIV,IPOS,IRANK,
     *IRNCP,IROWS,ISAVE,ISING,ISTART,ISW1,ISW,ITOP,J1,J2,J,JBEG,JCOUNT,JDIFF,JEND,JJ,JMORE,JNPOS,JOLD,JPIV,JPOS,JROOM,JVAL,JZER,JZER
     *O,K,L,LC,LENPIV,LL,LR,MINICN,MINIRN,MOREI,N,NBLOCK,NC,NERR,NNM1,NR,NUM,NZ2,NZ,NZCOL,NZMIN,NZPC,NZROW,OLDEND,OLDPIV,PIVEND,PIVO
     *T,PIVROW,ROWI
      DATANPZLAT/3/
      DATAUMAX/.9999D0/
      DATAZERO/0.0D0/
      ISAVE=IFAIL
      IFAIL=0
      CALLX04AAF(0,NERR)
      MINIRN=0
      MINICN=IDISP(1)-1
      MOREI=0
      IRANK=NN
      IRNCP=0
      ICNCP=0
      U=DMIN1(U,UMAX)
      U=DMAX1(U,ZERO)
      IBEG=IDISP(1)
      IACTIV=IDISP(2)
      NZROW=LICN-IACTIV+1
      MINICN=NZROW+MINICN
      NUM=1
      IPTR(1)=IACTIV
      IF(.NOT.((NN.NE.1)))GOTO09999
      NNM1=NN-1
      DO09996I=1,NNM1
      IF(IP(I).LT.0)NUM=NUM+1
      IPTR(I+1)=IPTR(I)+LENR(I)
09996 CONTINUE
09999 CONTINUE
      ILAST=0
      DO09993NBLOCK=1,NUM
      ISTART=ILAST+1
      DO09990IROWS=ISTART,NN
      IF(IP(IROWS).LT.0)GOTO80
09990 CONTINUE
      IROWS=NN
80    ILAST=IROWS
      N=ILAST-ISTART+1
      IF(.NOT.(N.EQ.1))GOTO09987
      LENRL(ILAST)=0
      ISING=ISTART
      IF(.NOT.((LENR(ILAST).EQ.0)))GOTO09984
      IRANK=IRANK-1
      ISING=-ISING
      IF(IFAIL.NE.-2.AND.IFAIL.NE.5)IFAIL=-1
      IF(.NOT.((ABORT(1))))GOTO09981
      IFAIL=1
      GOTO2020
09981 CONTINUE
      GOTO09983
09984 CONTINUE
      IF(.NOT.((A(IACTIV).EQ.ZERO)))GOTO09978
      ISING=-ISING
      IRANK=IRANK-1
      IPTR(ILAST)=0
      IF(IFAIL.NE.5)IFAIL=-2
      IF(.NOT.((ABORT(2))))GOTO09975
      IFAIL=2
      GOTO2020
09975 CONTINUE
      GOTO09977
09978 CONTINUE
      A(IBEG)=A(IACTIV)
      ICN(IBEG)=ICN(IACTIV)
      IACTIV=IACTIV+1
      IPTR(ISTART)=0
      IBEG=IBEG+1
      NZROW=NZROW-1
09977 CONTINUE
09983 CONTINUE
      LASTR(ISTART)=ISTART
      LASTC(ISTART)=ISING
      GOTO09986
09987 CONTINUE
      IF(.NOT.(ILAST.EQ.NN))GOTO09972
      ITOP=LICN
      GOTO09971
09972 CONTINUE
      ITOP=IPTR(ILAST+1)-1
09971 CONTINUE
      DO09969I=ISTART,ILAST
      LENRL(I)=0
      LENC(I)=0
09969 CONTINUE
      IF(.NOT.((ITOP-IACTIV.GE.LIRN)))GOTO09966
      MINIRN=ITOP-IACTIV+1
      PIVOT=ISTART-1
      GOTO1980
09966 CONTINUE
      DO09963II=IACTIV,ITOP
      I=ICN(II)
      LENC(I)=LENC(I)+1
09963 CONTINUE
      IPC(ILAST)=LIRN+1
      J1=ISTART+1
      DO09960JJ=J1,ILAST
      J=ILAST-JJ+J1-1
      IPC(J)=IPC(J+1)-LENC(J+1)
09960 CONTINUE
      DO09957INDROW=ISTART,ILAST
      J1=IPTR(INDROW)
      J2=J1+LENR(INDROW)-1
      IF(.NOT.((J1.LE.J2)))GOTO09954
      DO09951JJ=J1,J2
      J=ICN(JJ)
      IPOS=IPC(J)-1
      IRN(IPOS)=INDROW
      IPC(J)=IPOS
09951 CONTINUE
09954 CONTINUE
09957 CONTINUE
      DISPC=IPC(ISTART)
      NZCOL=LIRN-DISPC+1
      MINIRN=MAX0(NZCOL,MINIRN)
      NZMIN=1
      DO09948INZ=1,N
      IFIRST(INZ)=0
09948 CONTINUE
      DO09945II=ISTART,ILAST
      I=ILAST-II+ISTART
      NZ=LENR(I)
      IF(.NOT.(NZ.EQ.0))GOTO09942
      IPTR(I)=0
      LASTR(I)=0
      GOTO09941
09942 CONTINUE
      ISW=IFIRST(NZ)
      IFIRST(NZ)=I
      IF(.NOT.(ISW.LE.0))GOTO09939
      NEXTR(I)=0
      LASTR(I)=ISW
      GOTO09938
09939 CONTINUE
      NEXTR(I)=ISW
      LASTR(I)=LASTR(ISW)
      LASTR(ISW)=I
09938 CONTINUE
09941 CONTINUE
09945 CONTINUE
      DO09936PIVOT=ISTART,ILAST
      NSCAN=MIN(NPZLAT,ILAST+1-PIVOT)
      NZ2=NZMIN
      N8=N
      JCOST=N8**2
      DO660L=1,2
      LL=L
      ISCAN=0
      NZ=NZ2
09933 IF(.NOT.(ISCAN.LT.NSCAN.AND.NZ.LE.N))GOTO09932
      IJFIR=IFIRST(NZ)
      IF(.NOT.(IJFIR.GT.0))GOTO09930
      LL=2
09927 IF(.NOT.(ISCAN.LT.NSCAN.AND.IJFIR.NE.0))GOTO09926
      ISCAN=ISCAN+1
      I=IJFIR
      IJFIR=NEXTR(I)
      RMAX=ZERO
      J1=IPTR(I)+LENRL(I)
      IF(.NOT.(ISCAN.EQ.1))GOTO09924
      IJPOS=J1
      IPIV=I
      JPIV=ICN(J1)
09924 CONTINUE
      J2=IPTR(I)+LENR(I)-1
      DOJJ=J1,J2
      RMAX=DMAX1(RMAX,DABS(A(JJ)))
      ENDDO
      AU=RMAX*U
      DOJJ=J1,J2
      IF(DABS(A(JJ)).GT.AU.or.L.NE.1)THEN
      J=ICN(JJ)
      KCOST=(NZ-1)*(LENC(J)-1)
      IF((KCOST.LT.JCOST).or.(KCOST.EQ.JCOST.and.DABS(A(JJ)).GT.DABS(A(IJPOS))))THEN
      JCOST=KCOST
      IJPOS=JJ
      IPIV=I
      JPIV=J
      ENDIF
      ENDIF
      ENDDO
      GOTO09927
09926 CONTINUE
      GOTO09929
09930 CONTINUE
      IF(.NOT.(LL.EQ.1.AND.IJFIR.EQ.0))GOTO09921
      NZMIN=NZ+1
09921 CONTINUE
09929 CONTINUE
      NZ=NZ+1
      GOTO09933
09932 CONTINUE
      IF(ISCAN.EQ.NSCAN)GOTO820
      IRANK=IRANK-1
660   CONTINUE
      WRITE(*,662)ISCAN
662   Format(' ISCAN=',I8)
      IF(IFAIL.NE.-2.AND.IFAIL.NE.5)IFAIL=-1
      IRANK=IRANK-ILAST+PIVOT+1
      IF(.NOT.(ABORT(1)))GOTO09918
      IFAIL=1
      GOTO2020
09918 CONTINUE
      K=PIVOT-1
      I=ISTART
09915 IF(.NOT.(I.LE.ILAST.AND.LENRL(I).NE.0))GOTO09914
      IF(.NOT.(LASTR(I).EQ.0))GOTO09912
      K=K+1
      LASTR(I)=K
      IF(.NOT.(LENRL(I).NE.0))GOTO09909
      MINICN=MAX0(MINICN,NZROW+IBEG-1+MOREI+LENRL(I))
      IF(.NOT.(IACTIV-IBEG.LT.LENRL(I)))GOTO09906
      CALLF01BRS(A,ICN,IPTR(ISTART),N,IACTIV,ITOP,.TRUE.,ICNCP)
      IF(.NOT.(IACTIV-IBEG.LT.LENRL(I)))GOTO09903
      MOREI=MOREI+IBEG-IDISP(1)
      IBEG=IDISP(1)
      IFAIL=5
      IF(ABORT(3))GOTO2020
      IF(MOD(ISAVE/10,10).NE.0)WRITE(NERR,99997)
09903 CONTINUE
09906 CONTINUE
      J1=IPTR(I)
      J2=J1+LENRL(I)-1
      IPTR(I)=0
      DO09900JJ=J1,J2
      A(IBEG)=A(JJ)
      ICN(IBEG)=ICN(JJ)
      ICN(JJ)=0
      IBEG=IBEG+1
09900 CONTINUE
      NZROW=NZROW-LENRL(I)
09909 CONTINUE
09912 CONTINUE
      I=I+1
      GOTO09915
09914 CONTINUE
780   K=PIVOT-1
      DO09897I=ISTART,ILAST
      IF(.NOT.((LASTC(I).EQ.0)))GOTO09894
      K=K+1
      LASTC(I)=-K
      IF(K.EQ.ILAST)GOTO09935
09894 CONTINUE
09897 CONTINUE
820   ISING=PIVOT
      IF(.NOT.((A(IJPOS).EQ.ZERO)))GOTO09891
      Idisp(11)=IP(IPIV)
      Write(6,*)' I sing=',IP(IPIV)
      ISING=-ISING
      IF(IFAIL.NE.5)IFAIL=-2
      IF(.NOT.((ABORT(2))))GOTO09888
      IFAIL=2
      GOTO2020
09888 CONTINUE
09891 CONTINUE
      OLDPIV=IPTR(IPIV)+LENRL(IPIV)
      OLDEND=IPTR(IPIV)+LENR(IPIV)-1
      I1=IPC(JPIV)
      I2=I1+LENC(JPIV)-1
      DO09885II=I1,I2
      I=IRN(II)
      LR=LASTR(I)
      NR=NEXTR(I)
      IF(NR.NE.0)LASTR(NR)=LR
      IF(.NOT.(LR.GT.0))GOTO09882
      NEXTR(LR)=NR
      GOTO09881
09882 CONTINUE
      NZ=LENR(I)-LENRL(I)
      IF(.NOT.(NR.NE.0))GOTO09879
      IFIRST(NZ)=NR
      GOTO09878
09879 CONTINUE
      IFIRST(NZ)=0
09878 CONTINUE
09881 CONTINUE
09885 CONTINUE
      LASTC(JPIV)=ISING
      LASTR(IPIV)=PIVOT
      IF(.NOT.(OLDPIV.NE.IJPOS))GOTO09876
      AU=A(OLDPIV)
      A(OLDPIV)=A(IJPOS)
      A(IJPOS)=AU
      ICN(IJPOS)=ICN(OLDPIV)
      ICN(OLDPIV)=JPIV
09876 CONTINUE
      MINICN=MAX0(MINICN,NZROW+IBEG-1+MOREI+LENR(IPIV))
      IF(.NOT.(IACTIV-IBEG.LT.LENR(IPIV)))GOTO09873
      CALLF01BRS(A,ICN,IPTR(ISTART),N,IACTIV,ITOP,.TRUE.,ICNCP)
      OLDPIV=IPTR(IPIV)+LENRL(IPIV)
      OLDEND=IPTR(IPIV)+LENR(IPIV)-1
      IF(.NOT.(IACTIV-IBEG.LT.LENR(IPIV)))GOTO09870
      MOREI=MOREI+IBEG-IDISP(1)
      IBEG=IDISP(1)
      IFAIL=5
      IF(ABORT(3))GOTO2020
      IF(MOD(ISAVE/10,10).NE.0)WRITE(NERR,99997)
      IF(.NOT.(IACTIV-IBEG.LT.LENR(IPIV)))GOTO09867
      IFAIL=4
      GOTO2020
09867 CONTINUE
09870 CONTINUE
09873 CONTINUE
      IJPOS=0
      J1=IPTR(IPIV)
      DO09864JJ=J1,OLDEND
      A(IBEG)=A(JJ)
      ICN(IBEG)=ICN(JJ)
      IF(.NOT.((IJPOS.EQ.0)))GOTO09861
      IF(ICN(JJ).EQ.JPIV)IJPOS=IBEG
      ICN(JJ)=0
      GOTO09860
09861 CONTINUE
      K=IBEG-IJPOS
      J=ICN(JJ)
      ICN(JJ)=IQ(J)
      IQ(J)=-K
09860 CONTINUE
      IBEG=IBEG+1
09864 CONTINUE
      IJP1=IJPOS+1
      PIVEND=IBEG-1
      LENPIV=PIVEND-IJPOS
      NZROW=NZROW-LENRL(IPIV)-1
      IPTR(IPIV)=OLDPIV+1
      IF(LENPIV.EQ.0)IPTR(IPIV)=0
      DO09858JJ=IJPOS,PIVEND
      J=ICN(JJ)
      I1=IPC(J)
      LENC(J)=LENC(J)-1
      I2=IPC(J)+LENC(J)-1
      IF(.NOT.((I2.GE.I1)))GOTO09855
      DO09852II=I1,I2
      IF(.NOT.((IRN(II).EQ.IPIV)))GOTO09849
      IRN(II)=IRN(I2+1)
      GOTO09851
09849 CONTINUE
09852 CONTINUE
09851 CONTINUE
09855 CONTINUE
      IRN(I2+1)=0
09858 CONTINUE
      NZCOL=NZCOL-LENPIV-1
      NZPC=LENC(JPIV)
      IF(.NOT.(NZPC.NE.0))GOTO09846
      DO09843III=1,NZPC
      II=IPC(JPIV)+III-1
      I=IRN(II)
      J1=IPTR(I)+LENRL(I)
      IEND=IPTR(I)+LENR(I)-1
      JJ=J1
09840 IF(.NOT.(ICN(JJ).NE.JPIV.AND.JJ.LE.IEND))GOTO09839
      JJ=JJ+1
      GOTO09840
09839 CONTINUE
      IF(.NOT.(JJ.LE.IEND))GOTO09837
      IF(.NOT.(A(IJPOS).EQ.ZERO))GOTO09834
      AU=ZERO
      GOTO09833
09834 CONTINUE
      AU=-A(JJ)/A(IJPOS)
09833 CONTINUE
      A(JJ)=A(J1)
      A(J1)=AU
      ICN(JJ)=ICN(J1)
      ICN(J1)=JPIV
      LENRL(I)=LENRL(I)+1
09837 CONTINUE
      IF(.NOT.(LENPIV.NE.0))GOTO09831
      ROWI=J1+1
      IOP=0
      IF(.NOT.(ROWI.LE.IEND))GOTO09828
      DO1140JJ=ROWI,IEND
      J=ICN(JJ)
      IF(IQ(J).GT.0)GOTO1140
      IOP=IOP+1
      PIVROW=IJPOS-IQ(J)
      A(JJ)=A(JJ)+AU*A(PIVROW)
      ICN(PIVROW)=-ICN(PIVROW)
1140  CONTINUE
09828 CONTINUE
      IFILL=LENPIV-IOP
      DO1162JJ=IJP1,PIVEND
      J=ICN(JJ)
      IF(J.LT.0)GOTO1162
      IF(.NOT.(DABS(AU*A(JJ)).LT.THR))GOTO09825
      ICN(JJ)=-J
      IFILL=IFILL-1
09825 CONTINUE
1162  CONTINUE
      IF(.NOT.(IFILL.NE.0))GOTO09822
      MINICN=MAX0(MINICN,MOREI+IBEG-1+NZROW+IFILL+LENR(I))
      DO09819JDIFF=1,IFILL
      JNPOS=IEND+JDIFF
      IF(JNPOS.GT.LICN)GOTO1200
      IF(ICN(JNPOS).NE.0)GOTO1200
09819 CONTINUE
      IEND=IEND+1
      GOTO1360
1200  JMORE=IFILL-JDIFF+1
      I1=IPTR(I)
      DO09816JDIFF=1,JMORE
      JNPOS=I1-JDIFF
      IF(JNPOS.LT.IACTIV)GOTO1240
      IF(ICN(JNPOS).NE.0)GOTO1260
09816 CONTINUE
1240  JNPOS=I1-JMORE
      GOTO1280
1260  JNPOS=IACTIV-LENR(I)-IFILL
1280  continue
      IF(.NOT.(JNPOS.LT.IBEG))GOTO09813
      CALLF01BRS(A,ICN,IPTR(ISTART),N,IACTIV,ITOP,.TRUE.,ICNCP)
      I1=IPTR(I)
      IEND=I1+LENR(I)-1
      JNPOS=IACTIV-LENR(I)-IFILL
      IF(.NOT.(JNPOS.LT.IBEG))GOTO09810
      MOREI=MOREI+IBEG-IDISP(1)-LENPIV-1
      IFAIL=5
      IF(ABORT(3))GOTO2020
      IF(MOD(ISAVE/10,10).NE.0)WRITE(NERR,99997)
      IBEG=IDISP(1)
      ICN(IBEG)=JPIV
      A(IBEG)=A(IJPOS)
      IJPOS=IBEG
      DO09807JJ=IJP1,PIVEND
      IBEG=IBEG+1
      A(IBEG)=A(JJ)
      ICN(IBEG)=ICN(JJ)
09807 CONTINUE
      IJP1=IJPOS+1
      PIVEND=IBEG
      IBEG=IBEG+1
      IF(.NOT.(JNPOS.LT.IBEG))GOTO09804
      IFAIL=4
      GOTO2020
09804 CONTINUE
09810 CONTINUE
09813 CONTINUE
      IACTIV=MIN0(IACTIV,JNPOS)
      IPTR(I)=JNPOS
      DO09801JJ=I1,IEND
      A(JNPOS)=A(JJ)
      ICN(JNPOS)=ICN(JJ)
      JNPOS=JNPOS+1
      ICN(JJ)=0
09801 CONTINUE
      IEND=JNPOS
09822 CONTINUE
1360  NZROW=NZROW+IFILL
      IENBEG=IEND
      DO09798JJ=IJP1,PIVEND
      J=ICN(JJ)
      IF(.NOT.(J.GT.0))GOTO09795
      A(IEND)=AU*A(JJ)
      ICN(IEND)=J
      IEND=IEND+1
      MINIRN=MAX0(MINIRN,NZCOL+LENC(J)+1)
      JEND=IPC(J)+LENC(J)
      JROOM=NZPC-III+1+LENC(J)
      IF(.NOT.((JEND.LE.LIRN.AND.IRN(min(LIRN,JEND)).NE.0).or.JEND.GT.LIRN))GOTO09792
      IF(.NOT.(JROOM.GE.DISPC))GOTO09789
      CALLF01BRS(A,IRN,IPC(ISTART),N,DISPC,LIRN,.FALSE.,IRNCP)
      IF(.NOT.(JROOM.GE.DISPC))GOTO09786
      JROOM=DISPC-1
      IF(.NOT.(JROOM.LT.LENC(J)+1))GOTO09783
      GOTO1980
09783 CONTINUE
09786 CONTINUE
09789 CONTINUE
      JBEG=IPC(J)
      JEND=IPC(J)+LENC(J)-1
      JZERO=DISPC-1
      DISPC=DISPC-JROOM
      IDISPC=DISPC
      DO09780II=JBEG,JEND
      IRN(IDISPC)=IRN(II)
      IRN(II)=0
      IDISPC=IDISPC+1
09780 CONTINUE
      IPC(J)=DISPC
      JEND=IDISPC
      DO09777II=JEND,JZERO
      IRN(II)=0
09777 CONTINUE
09792 CONTINUE
      IRN(JEND)=I
      NZCOL=NZCOL+1
      LENC(J)=LENC(J)+1
      GOTO09794
09795 CONTINUE
      ICN(JJ)=-J
09794 CONTINUE
09798 CONTINUE
      LENR(I)=LENR(I)+IFILL
09831 CONTINUE
09843 CONTINUE
      I1=IPC(JPIV)
      I2=IPC(JPIV)+LENC(JPIV)-1
      NZCOL=NZCOL-LENC(JPIV)
      DO09774II=I1,I2
      I=IRN(II)
      IRN(II)=0
      NZ=LENR(I)-LENRL(I)
      IF(.NOT.(NZ.EQ.0))GOTO09771
      LASTR(I)=0
      GOTO09770
09771 CONTINUE
      IFIR=IFIRST(NZ)
      IFIRST(NZ)=I
      IF(.NOT.(IFIR.NE.0))GOTO09768
      LASTR(I)=LASTR(IFIR)
      NEXTR(I)=IFIR
      LASTR(IFIR)=I
      GOTO09767
09768 CONTINUE
      LASTR(I)=0
      NEXTR(I)=0
      NZMIN=MIN0(NZMIN,NZ)
09767 CONTINUE
09770 CONTINUE
09774 CONTINUE
09846 CONTINUE
      IPC(JPIV)=0
      IF(.NOT.((LENPIV.NE.0)))GOTO09765
      NZROW=NZROW-LENPIV
      JVAL=IJP1
      JZER=IPTR(IPIV)
      IPTR(IPIV)=0
      DO09762JCOUNT=1,LENPIV
      J=ICN(JVAL)
      IQ(J)=ICN(JZER)
      ICN(JZER)=0
      JVAL=JVAL+1
      JZER=JZER+1
09762 CONTINUE
756   Format(' ICN LUDI:',10I6)
09765 CONTINUE
09936 CONTINUE
09935 CONTINUE
      IF(ILAST.NE.NN)IACTIV=IPTR(ILAST+1)
09986 CONTINUE
09993 CONTINUE
      IF(.NOT.(IRANK.NE.NN))GOTO09759
      DO09756I=1,NN
      IF(.NOT.(LASTC(I).LE.0))GOTO09753
      ISING=-LASTC(I)
      IQ(ISING)=-IQ(ISING)
      LASTC(I)=ISING
09753 CONTINUE
09756 CONTINUE
09759 CONTINUE
      ISTART=IDISP(1)
      IEND=IBEG-1
      DO09750JJ=ISTART,IEND
      JOLD=ICN(JJ)
      ICN(JJ)=LASTC(JOLD)
09750 CONTINUE
      DO09747II=1,NN
      I=LASTR(II)
      NEXTR(I)=LENR(II)
      NEXTC(I)=LENRL(II)
09747 CONTINUE
      DO09744I=1,NN
      LENRL(I)=NEXTC(I)
      LENR(I)=NEXTR(I)
09744 CONTINUE
      DO09741II=1,NN
      I=LASTR(II)
      J=LASTC(II)
      NEXTR(I)=IABS(IP(II))
      NEXTC(J)=IABS(IQ(II))
09741 CONTINUE
      DO09738I=1,NN
      IF(IP(I).LT.0)NEXTR(I)=-NEXTR(I)
      IP(I)=NEXTR(I)
      IF(IQ(I).LT.0)NEXTC(I)=-NEXTC(I)
      IQ(I)=NEXTC(I)
09738 CONTINUE
      IP(NN)=IABS(IP(NN))
      IDISP(2)=IEND
      IF(IFAIL.NE.5)GOTO2060
      IF(MOD(ISAVE/10,10).NE.0)WRITE(NERR,99991)MINICN
      GOTO2060
1980  continue
      IF(.NOT.(IFAIL.NE.5))GOTO09735
      IFAIL=3
      GOTO09734
09735 CONTINUE
      IFAIL=6
09734 CONTINUE
2020  CONTINUE
      IF(.NOT.(MOD(ISAVE/10,10).NE.0))GOTO09732
      GOTO(09729,09728,09727,09726,09725,09724),IFAIL
      GOTO09723
09729 CONTINUE
      WRITE(NERR,99999)
      GOTO09723
09728 CONTINUE
      WRITE(NERR,99998)
      GOTO09723
09727 CONTINUE
      WRITE(NERR,99996)
      GOTO09723
09726 CONTINUE
      WRITE(NERR,99995)
      GOTO09723
09725 CONTINUE
      WRITE(NERR,99994)
      GOTO09723
09724 CONTINUE
      WRITE(NERR,99993)
09723 CONTINUE
      IF(.NOT.(IFAIL.GT.2))GOTO09722
      PIVOT=PIVOT-ISTART+1
      WRITE(NERR,99992)PIVOT,NBLOCK,ISTART,ILAST
      IF(PIVOT.EQ.0)WRITE(NERR,99990)MINIRN
09722 CONTINUE
09732 CONTINUE
      IDISP(2)=IACTIV
2060  IDISP(3)=IRNCP
      IDISP(4)=ICNCP
      IDISP(5)=IRANK
      IDISP(6)=MINIRN
      IDISP(7)=MINICN
      RETURN
99999 FORMAT(50H0MATRIX IS STRUCTURALLY SINGULAR - DECOMPOSITION A,6HBORTED)
99998 FORMAT(50H0MATRIX IS NUMERICALLY SINGULAR - DECOMPOSITION AB,5HORTED)
99997 FORMAT(48H0LU DECOMPOSITION DESTROYED TO CREATE MORE SPACE)
99996 FORMAT(17H0LIRN TOO SMALL -)
99995 FORMAT(22H0LICN MUCH TOO SMALL -)
99994 FORMAT(17H0LICN TOO SMALL -)
99993 FORMAT(26H0LICN AND LIRN TOO SMALL -)
99992 FORMAT(33H  DECOMPOSITION ABORTED AT STAGE ,I5,9H IN BLOCK,1H ,I5/17H  WITH FIRST ROW ,I5,14H AND LAST ROW ,I5)
99991 FORMAT(17H0LICN TOO SMALL -/29H  FOR SUCCESSFUL DECOMPOSITIO,23HN SET LICN TO AT LEAST ,I8)
99990 FORMAT(35H  TO CONTINUE SET LIRN TO AT LEAST ,I8)
      END
      SUBROUTINEM28BYS(N,NZ,A,LICN,IVECT,JVECT,ICN,IKEEP,IW,W,GROW,EPS,RMIN,ABORT,IDISP,IFAIL)
      DOUBLEPRECISIONEPS,RMIN
      INTEGERIFAIL,LICN,N,NZ
      LOGICALABORT,GROW
      DOUBLEPRECISIONA(LICN),W(N)
      INTEGERICN(LICN),IDISP(2),IKEEP(N,5),IVECT(NZ),IW(N,5),JVECT(NZ)
      CHARACTER*6SRNAME
      PARAMETER(SRNAME='M28BYS')
      DOUBLEPRECISIONWMAX
      INTEGERI1,IEND,IR,ISAVE,NERR
      CHARACTER*1P01REC(1)
      CHARACTER*65REC(2)
      INTEGERP01ABF
      EXTERNALP01ABF
      EXTERNALF01BRQ,M30BYS,X04AAF,X04BAF
      INTRINSICMOD
      ISAVE=IFAIL
      CALLX04AAF(0,NERR)
      IF(N.GT.0)GOTO20
      IFAIL=1
      GOTO120
20    IF(NZ.GT.0)GOTO40
      IFAIL=2
      GOTO120
40    IF(LICN.GE.NZ)GOTO60
      IFAIL=3
      GOTO120
60    CALLM28DYS(N,A,LICN,IVECT,JVECT,NZ,ICN,IKEEP,IKEEP(1,4),IKEEP(1,5),IKEEP(1,2),IKEEP(1,3),IW(1,3),IW,W(1),ABORT,IDISP,IFAIL)
      WMAX=W(1)
      IF(IFAIL.NE.0)GOTO120
      IFAIL=ISAVE
      CALLM30BYS(N,ICN,A,LICN,IKEEP,IKEEP(1,4),IDISP,IKEEP(1,2),IKEEP(1,3),W,IW,EPS,RMIN,IFAIL)
      IF(IFAIL.EQ.0)GOTO100
      IF(IFAIL.GT.0)GOTO80
      IR=-IFAIL
      IFAIL=6
      GOTO120
80    IR=IFAIL
      IFAIL=7
100   I1=IDISP(1)
      IEND=LICN-I1+1
      IF(GROW)CALLF01BRQ(N,ICN,A(I1),IEND,IKEEP,IKEEP(1,4),W)
      IF(GROW)W(1)=W(1)+WMAX
      IF(IFAIL.EQ.0)GOTO160
120   CONTINUE
      IF(MOD(ISAVE/10,10).EQ.0)GOTO140
      CALLX04AAF(0,NERR)
      GOTO(09999,09998,09997,09996,09995,09994,09993,09992),IFAIL
      GOTO09991
09999 CONTINUE
      WRITE(REC,FMT=99999)N
      GOTO09991
09998 CONTINUE
      WRITE(REC,FMT=99998)NZ
      GOTO09991
09997 CONTINUE
      WRITE(REC,FMT=99997)LICN,NZ
      GOTO09991
09996 CONTINUE
      GOTO09991
09995 CONTINUE
      GOTO09991
09994 CONTINUE
      IW(1,1)=IR
      GOTO09991
09993 CONTINUE
      GOTO09991
09992 CONTINUE
      WRITE(REC,99994)
09991 CONTINUE
      IF((IFAIL.GE.1.AND.IFAIL.LE.3).OR.(IFAIL.GE.6.AND.IFAIL.LE.8))THEN
      CALLX04BAF(NERR,REC(1))
      CALLX04BAF(NERR,REC(2))
      ENDIF
      IF(IFAIL.EQ.7)GOTO160
140   IFAIL=P01ABF(ISAVE,IFAIL,SRNAME,0,P01REC)
160   RETURN
99999 FORMAT(/' ON ENTRY N .LE. 0 , N =',I10)
99998 FORMAT(/' ON ENTRY NZ .LE. 0 , NZ =',I10)
99997 FORMAT(/' ON ENTRY LICN .LT. NZ , LICN = ',I9,'  NZ = ',I9)
99996 FORMAT(/' NUMERICAL SINGULARITY IN ROW ',I8,' - DECOMPOSITION A','BORTED')
99995 FORMAT(/' SUBTHRESHOLD PIVOT IN ROW ',I8,' - DECOMPOSITION COMP','LETED')
99994 FORMAT(/' DUPLICATE ELEMENTS FOUND ON INPUT - SEE ADVISORY MESS','AGES')
      END
      SUBROUTINEM30BYS(N,ICN,A,LICN,LENR,LENRL,IDISP,IP,IQ,W,IW,EPS,RMIN,IFAIL)
      DOUBLEPRECISIONEPS,RMIN
      INTEGERIFAIL,LICN,N
      DOUBLEPRECISIONA(LICN),W(N)
      INTEGERICN(LICN),IDISP(2),IP(N),IQ(N),IW(N,2),LENR(N),LENRL(N)
      DOUBLEPRECISIONAU,ONE,ROWMAX,ZERO
      INTEGERI,IFIN,ILEND,IPIVJ,ISING,ISTART,J,JAY,JAYJAY,JFIN,JJ,PIVPOS,KIW
      LOGICALSTAB
      DATAZERO/0.0D0/,ONE/1.0D0/
      STAB=EPS.LE.ONE
      RMIN=EPS
      ISING=0
      IFAIL=0
      IF(N.EQ.1)GOTO320
      KIW=0
      DO20I=1,N
      W(I)=ZERO
20    CONTINUE
      IW(1,1)=IDISP(1)
      DO40I=2,N
      IW(I,1)=IW(I-1,1)+LENR(I-1)
40    CONTINUE
      DO280I=1,N
      ISTART=IW(I,1)
      IFIN=ISTART+LENR(I)-1
      ILEND=ISTART+LENRL(I)-1
      IF(ISTART.GT.ILEND)GOTO140
      DO60JJ=ISTART,IFIN
      J=ICN(JJ)
      W(J)=A(JJ)
60    CONTINUE
      DO100JJ=ISTART,ILEND
      J=ICN(JJ)
      IPIVJ=IW(J,1)+LENRL(J)
      AU=-W(J)/A(IPIVJ)
      IF(.NOT.(W(J).EQ.ZERO))GOTO09990
      KIW=KIW+1
      IW(KIW,2)=J
09990 CONTINUE
      W(J)=AU
      IPIVJ=IPIVJ+1
      JFIN=IW(J,1)+LENR(J)-1
      IF(IPIVJ.GT.JFIN)GOTO100
      DO80JAYJAY=IPIVJ,JFIN
      JAY=ICN(JAYJAY)
      IF(.NOT.(W(JAY).EQ.ZERO))GOTO09987
      KIW=KIW+1
      IW(KIW,2)=JAY
09987 CONTINUE
      W(JAY)=W(JAY)+AU*A(JAYJAY)
80    CONTINUE
100   CONTINUE
      DO120JJ=ISTART,IFIN
      J=ICN(JJ)
      A(JJ)=W(J)
120   CONTINUE
      DO09984JAY=1,KIW
      J=IW(JAY,2)
      W(J)=ZERO
09984 CONTINUE
      KIW=0
140   PIVPOS=ILEND+1
      IF(IQ(I).GT.0)GOTO240
      IF(ISING.EQ.0)ISING=I
      IF(PIVPOS.GT.IFIN)GOTO160
      IF(A(PIVPOS).NE.ZERO)GOTO300
160   IF(ISTART.GT.IFIN)GOTO200
      DO180JJ=ISTART,IFIN
      IF(ICN(JJ).LT.ISING)GOTO180
      IF(A(JJ).NE.ZERO)GOTO300
180   CONTINUE
200   IF(PIVPOS.LE.IFIN)A(PIVPOS)=ONE
      IF(IP(I).GT.0.AND.I.NE.N)GOTO280
      DO220J=ISING,I
      IF((LENR(J)-LENRL(J)).EQ.0)GOTO220
      JJ=IW(J,1)+LENRL(J)
      A(JJ)=ZERO
220   CONTINUE
      ISING=0
      GOTO280
240   IF(PIVPOS.GT.IFIN)GOTO300
      IF(A(PIVPOS).EQ.ZERO)GOTO300
      IF(.NOT.STAB)GOTO280
      ROWMAX=ZERO
      DO260JJ=PIVPOS,IFIN
      ROWMAX=DMAX1(ROWMAX,DABS(A(JJ)))
260   CONTINUE
      IF(DABS(A(PIVPOS))/ROWMAX.GE.RMIN)GOTO280
      IFAIL=I
      RMIN=DABS(A(PIVPOS))/ROWMAX
280   CONTINUE
      GOTO320
300   IFAIL=-I
320   RETURN
      END
      SUBROUTINEM28DYS(N,A,LICN,IVECT,JVECT,NZ,ICN,LENR,LENRL,LENOFF,IP,IQ,IW1,IW,W1,ABORT,IDISP,IFAIL)
      DOUBLEPRECISIONW1
      INTEGERIFAIL,LICN,N,NZ
      LOGICALABORT
      DOUBLEPRECISIONA(LICN)
      INTEGERICN(LICN),IDISP(2),IP(N),IQ(N),IVECT(NZ),IW1(N,3),IW(N,2),JVECT(NZ),LENOFF(N),LENR(N),LENRL(N)
      DOUBLEPRECISIONAA,ZERO
      INTEGERI,IBLOCK,IDISP2,IDUMMY,II,INEW,IOLD,ISAVE,J1,J2,JCOMP,JDUMMY,JJ,JNEW,JOLD,MIDPT,NADV,NERR
      LOGICALBLOCKL
      DATAZERO/0.0D0/
      ISAVE=IFAIL
      IFAIL=0
      CALLX04AAF(0,NERR)
      CALLX04ABF(0,NADV)
      BLOCKL=LENOFF(1).GE.0
      IBLOCK=1
      IW(1,1)=1
      IW(1,2)=IDISP(1)
      DO20I=1,N
      IW1(I,3)=IBLOCK
      IF(IP(I).LT.0)IBLOCK=IBLOCK+1
      II=IABS(IP(I))
      IW1(II,1)=I
      JJ=IQ(I)
      JJ=IABS(JJ)
      IW1(JJ,2)=I
      IF(I.EQ.1)GOTO20
      IF(BLOCKL)IW(I,1)=IW(I-1,1)+LENOFF(I-1)
      IW(I,2)=IW(I-1,2)+LENR(I-1)
20    CONTINUE
      IDISP2=IDISP(2)
      DO340I=1,NZ
      IF(I.GT.IDISP2)GOTO40
      IF(ICN(I).LT.0)GOTO340
40    IOLD=IVECT(I)
      JOLD=JVECT(I)
      AA=A(I)
      DO280IDUMMY=1,NZ
      IF(IOLD.LE.N.AND.IOLD.GT.0.AND.JOLD.LE.N.AND.JOLD.GT.0)GOTO60
      IFAIL=4
      IF(MOD(ISAVE/10,10).NE.0)WRITE(NERR,99999)I,A(I),IOLD,JOLD
      GOTO360
60    INEW=IW1(IOLD,1)
      JNEW=IW1(JOLD,2)
      IF(IW1(INEW,3)-IW1(JNEW,3))80,120,100
80    IFAIL=5
      IF(MOD(ISAVE/10,10).NE.0)WRITE(NERR,99998)IOLD,JOLD
      GOTO360
100   J1=IW(INEW,1)
      J2=J1+LENOFF(INEW)-1
      GOTO220
120   J1=IW(INEW,2)
      IF(INEW.GT.JNEW)GOTO140
      J2=J1+LENR(INEW)-1
      J1=J1+LENRL(INEW)
      GOTO220
140   J2=J1+LENRL(INEW)
      DO200JDUMMY=1,N
      MIDPT=(J1+J2)/2
      JCOMP=IABS(ICN(MIDPT))
      IF(JNEW-JCOMP)160,260,180
160   J2=MIDPT
      GOTO200
180   J1=MIDPT
200   CONTINUE
      IFAIL=5
      IF(MOD(ISAVE/10,10).NE.0)WRITE(NERR,99997)IOLD,JOLD
      GOTO360
220   DO240MIDPT=J1,J2
      IF(IABS(ICN(MIDPT)).EQ.JNEW)GOTO260
240   CONTINUE
      IFAIL=5
      IF(MOD(ISAVE/10,10).NE.0)WRITE(NERR,99997)IOLD,JOLD
      GOTO360
260   IF(ICN(MIDPT).LT.0)GOTO320
      IF(MIDPT.GT.NZ.OR.MIDPT.LE.I)GOTO300
      W1=A(MIDPT)
      A(MIDPT)=AA
      AA=W1
      IOLD=IVECT(MIDPT)
      JOLD=JVECT(MIDPT)
      ICN(MIDPT)=-ICN(MIDPT)
280   CONTINUE
300   A(MIDPT)=AA
      ICN(MIDPT)=-ICN(MIDPT)
      GOTO340
320   A(MIDPT)=A(MIDPT)+AA
      IF(MOD(ISAVE/100,100).NE.0)WRITE(NADV,99996)IOLD,JOLD,AA
      IF(ABORT)IFAIL=8
340   CONTINUE
360   W1=ZERO
      DO400I=1,IDISP2
      IF(ICN(I).LT.0)GOTO380
      A(I)=ZERO
      GOTO400
380   ICN(I)=-ICN(I)
      W1=DMAX1(W1,DABS(A(I)))
400   CONTINUE
      RETURN
99999 FORMAT(49H0ON ENTRY IRN(I) OR ICN(I) IS OUT OF RANGE - I = ,I8/9H  A(I) = ,1PD14.6,11H  IRN(I) = ,I8,11H  ICN(I) = ,I8)
99998 FORMAT(19H0NON-ZERO ELEMENT (,I6,1H,,I6,13H) IN ZERO OFF,15H-DIAGONAL BLOCK)
99997 FORMAT(19H0NON-ZERO ELEMENT (,I6,1H,,I6,13H) WAS NOT IN ,11HL/U PATTERN)
99996 FORMAT(45H0M28DYS FOUND DUPLICATE ELEMENT WITH INDICES ,I6,2H, ,I6/10H  VALUE = ,1PD14.6)
      END
      SUBROUTINEM28CYS(N,A,LICN,ICN,IKEEP,RHS,W,MTYPE,IDISP,RESID)
      DOUBLEPRECISIONRESID
      INTEGERLICN,MTYPE,N
      DOUBLEPRECISIONA(LICN),RHS(N),W(N)
      INTEGERICN(LICN),IDISP(2),IKEEP(N,5)
      CALLM30CYS(N,ICN,A,LICN,IKEEP,IKEEP(1,4),IKEEP(1,5),IDISP,IKEEP(1,2),IKEEP(1,3),RHS,W,MTYPE,RESID)
      RETURN
      END
      SUBROUTINEM30CYS(N,ICN,A,LICN,LENR,LENRL,LENOFF,IDISP,IP,IQ,X,W,MTYPE,RESID)
      DOUBLEPRECISIONRESID
      INTEGERLICN,MTYPE,N
      DOUBLEPRECISIONA(LICN),W(N),X(N)
      INTEGERICN(LICN),IDISP(2),IP(N),IQ(N),LENOFF(N),LENR(N),LENRL(N)
      DOUBLEPRECISIONWI,WII,ZERO
      INTEGERI,IB,IBACK,IBLEND,IBLOCK,IEND,IFIRST,II,III,ILAST,J1,J2,J3,J,JJ,JPIV,JPIVP1,K,LJ1,LJ2,LT,LTEND,NUMBLK
      LOGICALNEG,NOBLOC
      DATAZERO/0.0D0/
      RESID=ZERO
      NOBLOC=LENOFF(1).LT.0
      IF(MTYPE.NE.1)GOTO280
      NEG=.FALSE.
      IP(N)=-IP(N)
      DO20II=1,N
      I=IP(II)
      I=IABS(I)
      W(II)=X(I)
20    CONTINUE
      LT=1
      IFIRST=1
      IBLOCK=IDISP(1)
      DO240I=1,N
      WI=W(I)
      IF(NOBLOC)GOTO60
      IF(LENOFF(I).EQ.0)GOTO60
      LTEND=LT+LENOFF(I)-1
      DO40JJ=LT,LTEND
      J=ICN(JJ)
      WI=WI-A(JJ)*W(J)
40    CONTINUE
      LT=LTEND+1
60    IF(IP(I).LT.0)NEG=.TRUE.
      IF(LENRL(I).EQ.0)GOTO100
      IEND=IBLOCK+LENRL(I)-1
      DO80JJ=IBLOCK,IEND
      J=ICN(JJ)
      WI=WI+A(JJ)*W(J)
80    CONTINUE
100   IBLOCK=IBLOCK+LENR(I)
      W(I)=WI
      IF(.NOT.NEG)GOTO240
      J1=IBLOCK
      IB=I
      IF(IQ(I).GT.0)GOTO140
      DO120III=IFIRST,I
      IB=I-III+IFIRST
      IF(IQ(IB).GT.0)GOTO140
      J1=J1-LENR(IB)
      RESID=DMAX1(RESID,DABS(W(IB)))
      W(IB)=ZERO
120   CONTINUE
      GOTO220
140   DO200III=IFIRST,IB
      II=IB-III+IFIRST
      J2=J1-1
      J1=J1-LENR(II)
      JPIV=J1+LENRL(II)
      JPIVP1=JPIV+1
      IF(J2.LT.JPIVP1)GOTO180
      WII=W(II)
      DO160JJ=JPIVP1,J2
      J=ICN(JJ)
      if(J.GT.N)write(*,*)' J = ICN(JJ), JJ ',J,JJ
      WII=WII-A(JJ)*W(J)
160   CONTINUE
      W(II)=WII
180   W(II)=W(II)/A(JPIV)
200   CONTINUE
220   IFIRST=I+1
      NEG=.FALSE.
240   CONTINUE
      DO260II=1,N
      I=IQ(II)
      I=IABS(I)
      X(I)=W(II)
260   CONTINUE
      IP(N)=-IP(N)
      GOTO640
280   DO300II=1,N
      I=IQ(II)
      I=IABS(I)
      W(II)=X(I)
300   CONTINUE
      LJ1=IDISP(1)
      IBLOCK=IDISP(2)+1
      ILAST=N
      IBLEND=IBLOCK
      DO580NUMBLK=1,N
      IF(ILAST.EQ.0)GOTO600
      IBLOCK=IBLOCK-LENR(ILAST)
      DO320K=1,N
      II=ILAST-K
      IF(II.EQ.0)GOTO340
      IF(IP(II).LT.0)GOTO340
      IBLOCK=IBLOCK-LENR(II)
320   CONTINUE
340   IFIRST=II+1
      J1=IBLOCK
      DO420I=IFIRST,ILAST
      IF(W(I).EQ.ZERO)GOTO400
      IF(IQ(I).LT.0)GOTO440
      J2=J1+LENRL(I)
      WI=W(I)/A(J2)
      IF(LENR(I)-LENRL(I).EQ.1)GOTO380
      J2=J2+1
      J3=J1+LENR(I)-1
      DO360JJ=J2,J3
      J=ICN(JJ)
      W(J)=W(J)-A(JJ)*WI
360   CONTINUE
380   W(I)=WI
400   J1=J1+LENR(I)
420   CONTINUE
      GOTO480
440   DO460II=I,ILAST
      RESID=DMAX1(RESID,DABS(W(II)))
      W(II)=ZERO
460   CONTINUE
480   J1=IBLEND
      DO560IBACK=IFIRST,ILAST
      I=ILAST-IBACK+IFIRST
      J1=J1-LENR(I)
      IF(LENRL(I).EQ.0)GOTO520
      J2=J1+LENRL(I)-1
      DO500JJ=J1,J2
      J=ICN(JJ)
      W(J)=W(J)+A(JJ)*W(I)
500   CONTINUE
520   IF(NOBLOC)GOTO560
      IF(LENOFF(I).EQ.0)GOTO560
      LJ2=LJ1-1
      LJ1=LJ1-LENOFF(I)
      DO540JJ=LJ1,LJ2
      J=ICN(JJ)
      W(J)=W(J)-A(JJ)*W(I)
540   CONTINUE
560   CONTINUE
      IBLEND=J1
      ILAST=IFIRST-1
580   CONTINUE
600   DO620II=1,N
      I=IP(II)
      I=IABS(I)
      X(I)=W(II)
620   CONTINUE
640   RETURN
      END
      SUBROUTINEM28CYN(N,A,LICN,ICN,IKEEP,RHS,W,IW,MTYPE,IDISP,RESID,Ifail)
      DOUBLEPRECISIONRESID
      INTEGERLICN,MTYPE,N
      DOUBLEPRECISIONA(LICN),RHS(N),W(N)
      INTEGERICN(LICN),IDISP(2),IKEEP(N,5)
      CALLM30CYN(N,ICN,A,LICN,IKEEP,IKEEP(1,4),IKEEP(1,5),IDISP,IKEEP(1,2),IKEEP(1,3),RHS,W,MTYPE,RESID,Ifail)
      RETURN
      END
      SUBROUTINEM30CYN(N,ICN,A,LICN,LENR,LENRL,LENOFF,IDISP,IP,IQ,X,W,MTYPE,RESID,Ifail)
      DOUBLEPRECISIONRESID
      INTEGERLICN,MTYPE,N
      DOUBLEPRECISIONA(LICN),W(N),X(N)
      INTEGERICN(LICN),IDISP(2),IP(N),IQ(N),LENOFF(N),LENR(N),LENRL(N)
      DOUBLEPRECISIONWI,WII,ZERO
      INTEGERI,IB,IBACK,IBLEND,IBLOCK,IEND,IFIRST,II,III,ILAST,J1,J2,J3,J,JJ,JPIV,JPIVP1,K,LJ1,LJ2,LT,LTEND,NUMBLK
      LOGICALNEG,NOBLOC
      DATAZERO/0.0D0/
      Ifail=0
      RESID=ZERO
      NOBLOC=LENOFF(1).LT.0
      IF(MTYPE.NE.1)GOTO280
      NEG=.FALSE.
      IP(N)=-IP(N)
      DO20II=1,N
      I=IP(II)
      I=IABS(I)
      if(I.LE.0)write(*,*)' warning 1 m28cyn.trf: I=',I
      W(II)=X(max(I,1))
20    CONTINUE
      LT=1
      IFIRST=1
      IBLOCK=IDISP(1)
      DO240I=1,N
      WI=W(I)
      If(.NOT.NOBLOC.AND.LENOFF(I).NE.0)Then
      LTEND=LT+LENOFF(I)-1
      DO40JJ=LT,LTEND
      J=ICN(JJ)
      If(abs(A(JJ)).LT.1.D0)Then
      WI=WI-A(JJ)*W(J)
      elseIf(abs(W(J)).LT.1.D+300/abs(A(JJ)))Then
      WI=WI-A(JJ)*W(J)
      else
      Ifail=13
      Return
      endif
40    CONTINUE
      LT=LTEND+1
      Endif
      IF(IP(I).LT.0)NEG=.TRUE.
      IF(LENRL(I).NE.0)Then
      IEND=IBLOCK+LENRL(I)-1
      DO80JJ=IBLOCK,IEND
      J=ICN(JJ)
      If(abs(A(JJ)).LT.1.D0)Then
      WI=WI+A(JJ)*W(J)
      elseIf(abs(W(J)).LT.1.D+300/abs(A(JJ)))Then
      WI=WI+A(JJ)*W(J)
      else
      Ifail=13
      Return
      endif
80    CONTINUE
      Endif
      IBLOCK=IBLOCK+LENR(I)
      W(I)=WI
      IF(.NOT.NEG)GOTO240
      J1=IBLOCK
      IB=I
      IF(IQ(I).GT.0)GOTO140
      DO120III=IFIRST,I
      IB=I-III+IFIRST
      IF(IQ(IB).GT.0)GOTO140
      J1=J1-LENR(IB)
      RESID=DMAX1(RESID,DABS(W(IB)))
      W(IB)=ZERO
120   CONTINUE
      GOTO220
140   DO200II=IB,IFIRST,-1
      J2=J1-1
      J1=J1-LENR(II)
      JPIV=J1+LENRL(II)
      JPIVP1=JPIV+1
      If(J2.GE.JPIVP1)Then
      WII=W(II)
      DO160JJ=JPIVP1,J2
      J=ICN(JJ)
      WII=WII-A(JJ)*W(J)
160   CONTINUE
      W(II)=WII
      Endif
      If(1.D+135.LT.abs(A(JPIV)))Then
      W(II)=W(II)/A(JPIV)
      elseIf(abs(W(II)).LT.1.D+135*abs(A(JPIV)))Then
      W(II)=W(II)/A(JPIV)
      else
      Ifail=13
      Return
      endif
200   CONTINUE
220   IFIRST=I+1
      NEG=.FALSE.
240   CONTINUE
      DO260II=1,N
      I=IQ(II)
      I=IABS(I)
      if(I.LE.0)write(*,*)' warning 2 m28cyn.trf: I=',I
      X(max(I,1))=W(II)
260   CONTINUE
      IP(N)=-IP(N)
      GOTO640
280   DO300II=1,N
      I=IQ(II)
      I=IABS(I)
      W(II)=X(I)
300   CONTINUE
      LJ1=IDISP(1)
      IBLOCK=IDISP(2)+1
      ILAST=N
      IBLEND=IBLOCK
      DO580NUMBLK=1,N
      IF(ILAST.EQ.0)GOTO600
      IBLOCK=IBLOCK-LENR(ILAST)
      DO320K=1,N
      II=ILAST-K
      IF(II.EQ.0)GOTO340
      IF(IP(II).LT.0)GOTO340
      IBLOCK=IBLOCK-LENR(II)
320   CONTINUE
340   IFIRST=II+1
      J1=IBLOCK
      DO420I=IFIRST,ILAST
      IF(W(I).EQ.ZERO)GOTO400
      IF(IQ(I).LT.0)GOTO440
      J2=J1+LENRL(I)
      WI=W(I)/A(J2)
      IF(LENR(I)-LENRL(I).EQ.1)GOTO380
      J2=J2+1
      J3=J1+LENR(I)-1
      DO360JJ=J2,J3
      J=ICN(JJ)
      W(J)=W(J)-A(JJ)*WI
360   CONTINUE
380   W(I)=WI
400   J1=J1+LENR(I)
420   CONTINUE
      GOTO480
440   DO460II=I,ILAST
      RESID=DMAX1(RESID,DABS(W(II)))
      W(II)=ZERO
460   CONTINUE
480   J1=IBLEND
      DO560IBACK=IFIRST,ILAST
      I=ILAST-IBACK+IFIRST
      J1=J1-LENR(I)
      IF(LENRL(I).EQ.0)GOTO520
      J2=J1+LENRL(I)-1
      DO500JJ=J1,J2
      J=ICN(JJ)
      W(J)=W(J)+A(JJ)*W(I)
500   CONTINUE
520   IF(NOBLOC)GOTO560
      IF(LENOFF(I).EQ.0)GOTO560
      LJ2=LJ1-1
      LJ1=LJ1-LENOFF(I)
      DO540JJ=LJ1,LJ2
      J=ICN(JJ)
      W(J)=W(J)-A(JJ)*W(I)
540   CONTINUE
560   CONTINUE
      IBLEND=J1
      ILAST=IFIRST-1
580   CONTINUE
600   DO620II=1,N
      I=IP(II)
      I=IABS(I)
      X(I)=W(II)
620   CONTINUE
640   RETURN
      END
